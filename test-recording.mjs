import FormData from 'form-data';
import fs from 'fs';
import path from 'path';

// Create a simple test image (1x1 pixel PNG)
const pngBuffer = Buffer.from([
  0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A,
  0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52,
  0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
  0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53,
  0xDE, 0x00, 0x00, 0x00, 0x0C, 0x49, 0x44, 0x41,
  0x54, 0x08, 0x99, 0x63, 0xF8, 0x0F, 0x00, 0x00,
  0x01, 0x01, 0x00, 0x01, 0x18, 0xDD, 0x8D, 0xB4,
  0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44,
  0xAE, 0x42, 0x60, 0x82
]);

// Create a simple test audio (silent WAV)
const wavBuffer = Buffer.from([
  0x52, 0x49, 0x46, 0x46, 0x24, 0x00, 0x00, 0x00,
  0x57, 0x41, 0x56, 0x45, 0x66, 0x6D, 0x74, 0x20,
  0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00,
  0x44, 0xAC, 0x00, 0x00, 0x88, 0x58, 0x01, 0x00,
  0x02, 0x00, 0x10, 0x00, 0x64, 0x61, 0x74, 0x61,
  0x00, 0x00, 0x00, 0x00
]);

const form = new FormData();
form.append('frame', pngBuffer, 'test-frame.png');
form.append('audio', wavBuffer, 'test-audio.wav');

const headers = {
  'x-user-id': 'test-student-001',
  'x-user-name': 'Test Student',
  'x-alert-id': `alert_${Date.now()}`,
  'x-timestamp': new Date().toISOString(),
  'x-location': JSON.stringify({ lat: 12.9716, lon: 77.5946 })
};

console.log('ğŸ§ª Sending test recording...');
console.log('   User: Test Student (test-student-001)');
console.log('   Files: 1 photo + 1 audio clip');

fetch('http://localhost:3001/api/receive', {
  method: 'POST',
  headers: {
    ...headers,
    ...form.getHeaders()
  },
  body: form
})
  .then(r => r.json())
  .then(data => {
    console.log('âœ… Response:', JSON.stringify(data, null, 2));
    console.log('\nğŸ’¾ Recording has been persisted to disk!');
    console.log('ğŸ“ Location: server/uploads/recordings-metadata.json');
  })
  .catch(err => console.error('âŒ Error:', err.message));
